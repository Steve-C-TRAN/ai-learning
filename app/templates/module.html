{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <div id="module-meta"
       data-slug="{{ module.slug }}"
       {% if course %}data-course-slug="{{ course.slug }}"{% endif %}
       {% if next_module %}
         {% if course %}
           data-next-url="{{ url_for('main.course_module_view', course_slug=course.slug, module_slug=next_module.slug) }}"
         {% else %}
           data-next-url="{{ url_for('main.module_view', slug=next_module.slug) }}"
         {% endif %}
       {% endif %}
       {% if course %}data-course-url="{{ url_for('main.course_view', course_slug=course.slug) }}"{% endif %}
  ></div>
  <div class="mb-8 mt-6 flex items-center justify-between">
    {% if course %}
    <a href="{{ url_for('main.course_view', course_slug=course.slug) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-sky-600 hover:bg-sky-700 text-white">
      <span>←</span>
      <span>Back to Course</span>
    </a>
    {% else %}
    <a href="/" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-sky-600 hover:bg-sky-700 text-white">
      <span>←</span>
      <span>Back to Modules</span>
    </a>
    {% endif %}
    {% if next_module %}
      {% if course %}
      <a href="{{ url_for('main.course_module_view', course_slug=course.slug, module_slug=next_module.slug) }}" class="next-module-link inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-emerald-600 hover:bg-emerald-700 text-white">
        <span>Next Module</span>
        <span>→</span>
      </a>
      {% else %}
      <a href="/module/{{ next_module.slug }}" class="next-module-link inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-emerald-600 hover:bg-emerald-700 text-white">
        <span>Next Module</span>
        <span>→</span>
      </a>
      {% endif %}
    {% endif %}
  </div>

  <h1 class="text-3xl font-bold mt-2">{{ module.title }}</h1>
  <p class="text-slate-300 mt-2">{{ module.summary }}</p>

  {% if module.guardrails and module.guardrails|length %}
  <div class="bg-amber-900/30 border border-amber-700/40 rounded-lg p-4 mb-6 mt-6">
    <h2 class="text-amber-300 font-semibold">Guardrails</h2>
    <ul class="list-disc ml-6 text-amber-200 text-sm mt-2">
      {% for g in module.guardrails %}
      <li>{{ g }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="space-y-6 mt-6">
    {% for s in module.sections %}
    <section class="glass-effect rounded-xl p-6 border border-slate-700/50 transition-colors duration-200 hover:border-emerald-500/70 focus-within:border-emerald-500/70">
      <h3 class="text-xl font-semibold mb-2">{{ s.title }}</h3>
      <div class="text-slate-200 space-y-3">{{ s.content|safe }}</div>
    </section>
    {% endfor %}
  </div>

  {% if questions and questions|length %}
  <div class="mt-8 glass-effect rounded-xl p-6 border border-slate-700/50">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold mb-3">Knowledge Check</h3>
      <div id="quiz-progress" class="text-xs text-slate-400"></div>
    </div>
    <div id="quiz-panel" class="space-y-3">
      <div id="quiz-prompt" class="text-slate-200"></div>
      <div id="quiz-options" class="space-y-2"></div>
      <div id="quiz-feedback" class="text-sm"></div>
      <div class="pt-2">
        <button id="quiz-next" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">Next Question</button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Bottom navigation buttons -->
  <div class="mt-10 flex items-center justify-between">
    {% if course %}
    <a href="{{ url_for('main.course_view', course_slug=course.slug) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-sky-600 hover:bg-sky-700 text-white">
      <span>←</span>
      <span>Back to Course</span>
    </a>
    {% else %}
    <a href="/" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-sky-600 hover:bg-sky-700 text-white">
      <span>←</span>
      <span>Back to Modules</span>
    </a>
    {% endif %}
    {% if next_module %}
      {% if course %}
      <a href="{{ url_for('main.course_module_view', course_slug=course.slug, module_slug=next_module.slug) }}" class="next-module-link inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-emerald-600 hover:bg-emerald-700 text-white">
        <span>Next Module</span>
        <span>→</span>
      </a>
      {% else %}
      <a href="/module/{{ next_module.slug }}" class="next-module-link inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm bg-emerald-600 hover:bg-emerald-700 text-white">
        <span>Next Module</span>
        <span>→</span>
      </a>
      {% endif %}
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function() {
  const metaEl = document.getElementById('module-meta');
  const slug = metaEl?.dataset?.slug || '';
  const courseSlug = metaEl?.dataset?.courseSlug || '';
  const sessionId = getOrSetSessionId();
  const nextModuleUrl = metaEl?.dataset?.nextUrl || null;
  const courseUrl = metaEl?.dataset?.courseUrl || null;

  // Helper to build course-scoped keys and endpoints
  const storageKey = courseSlug ? `${courseSlug}:${slug}` : slug;
  const quizEndpoint = courseSlug ? `/api/quiz/${courseSlug}/${slug}` : `/api/quiz/${slug}`;

  // Record view event
  fetch('/api/event', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: sessionId, event_type: 'view', module_slug: storageKey, page: window.location.pathname })
  });

  // If user clicks Next Module, mark complete then navigate
  document.querySelectorAll('.next-module-link').forEach(link => {
    link.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, module_slug: storageKey, completed: true })
        });
      } catch {}
      window.location.href = link.href;
    });
  });

  // Quiz logic
  const promptEl = document.getElementById('quiz-prompt');
  const optionsEl = document.getElementById('quiz-options');
  const feedbackEl = document.getElementById('quiz-feedback');
  const nextBtn = document.getElementById('quiz-next');
  const quizProgressEl = document.getElementById('quiz-progress');
  let currentQ = null;
  let quizCompleted = false;

  function updateNextButtonForCompletion() {
    if (!nextBtn) return;
    nextBtn.textContent = nextModuleUrl ? 'Complete & Next Module' : 'Complete';
    nextBtn.className = 'px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700';
  }

  async function loadQuestion() {
    if (!nextBtn) return;

    if (quizCompleted) {
      // Mark complete and navigate (or back to course/ home if last)
      try {
        await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, module_slug: storageKey, completed: true })
        });
      } catch {}
      window.location.href = nextModuleUrl || courseUrl || '/';
      return;
    }

    feedbackEl.textContent = '';
    optionsEl.innerHTML = '';
    promptEl.textContent = 'Loading question...';

    const res = await fetch(`${quizEndpoint}?session_id=${encodeURIComponent(sessionId)}`);
    const payload = await res.json();

    // Update progress text if provided
    if (typeof payload.total === 'number') {
      const remaining = payload.remaining ?? 0;
      const total = payload.total ?? 0;
      const done = total - remaining;
      quizProgressEl.textContent = total ? `${done}/${total} correct` : '';
    }

    if (payload.completed) {
      quizCompleted = true;
      promptEl.textContent = 'All questions answered correctly!';
      optionsEl.innerHTML = '';
      updateNextButtonForCompletion();
      return;
    }

    if (!payload.data) {
      promptEl.textContent = 'No questions available.';
      nextBtn.disabled = true;
      return;
    }

    const q = payload.data;
    currentQ = q;
    promptEl.textContent = q.prompt;

    Object.entries(q.options).forEach(([key, label]) => {
      const btn = document.createElement('button');
      btn.className = 'block w-full text-left px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700';
      btn.textContent = `${key.toUpperCase()}. ${label}`;
      btn.addEventListener('click', () => submitAnswer(key));
      optionsEl.appendChild(btn);
    });
  }

  async function submitAnswer(selected) {
    if (!currentQ) return;
    const res = await fetch(quizEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, question_id: currentQ.id, selected })
    });
    const payload = await res.json();
    if (payload.data?.correct) {
      feedbackEl.className = 'text-sm text-green-300';
      feedbackEl.textContent = 'Correct!';
    } else {
      feedbackEl.className = 'text-sm text-red-300';
      feedbackEl.textContent = 'Not quite.' + (payload.data?.help ? ' ' + payload.data.help : '');
    }
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', loadQuestion);
    loadQuestion();
  }
})();
</script>
{% endblock %}
